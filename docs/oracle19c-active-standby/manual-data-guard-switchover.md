# Manual Data Guard Switchover

## 1. Check database role and database name

```
[oracle@oracle01 db_1]$ sqlplus / as sysdba

SQL> select name,open_mode,database_role from v$database;

NAME	  OPEN_MODE	       DATABASE_ROLE
--------- -------------------- ----------------
ORACLE01  READ WRITE	       PRIMARY
```

```
[oracle@oracle02 dbs]$ sqlplus / as sysdba

SQL> select name,open_mode,database_role from v$database;

NAME	  OPEN_MODE	       DATABASE_ROLE
--------- -------------------- ----------------
ORACLE01  READ ONLY WITH APPLY PHYSICAL STANDBY

```

## Step2: Check switchover status

**On Primary server**

```
SQL> select switchover_status from v$database;

SWITCHOVER_STATUS
--------------------
TO STANDBY

SQL> 
```

**On Standby server**

```
SQL> select switchover_status from v$database;

SWITCHOVER_STATUS
--------------------
NOT ALLOWED

SQL> 
```

## 3. Verify that the target standby database is ready for switchover

Sure that verify successfully before switchover database role

```
SQL> ALTER DATABASE SWITCHOVER TO oracle02 VERIFY;

Database altered.
```

## 4. Switchover to standby

**On Primary server**

```
SQL> alter database commit to switchover to physical standby with session shutdown;

Database altered.

SQL> startup mount

Database altered.

SQL> select name,open_mode,database_role from v$database;

NAME	  OPEN_MODE	       DATABASE_ROLE
--------- -------------------- ----------------
ORACLE01  READ ONLY WITH APPLY PHYSICAL 
```

- Start to apply the redo log (MRP process)

```
SQL> alter database recover managed standby database disconnect from session;

Database altered.
```

**On Standby server**

```
SQL> select switchover_status from v$database;

SWITCHOVER_STATUS
--------------------
TO PRIMARY
```

- Stop the MRP process

`SQL> alter database recover managed standby database cancel;`

- Execute to convert standby to primary

```
SQL> alter database commit to switchover to primary with session shutdown;

Database altered.
```

- Check new role

```
SQL> select name, open_mode, database_role from v$database;

NAME	  OPEN_MODE	       DATABASE_ROLE
--------- -------------------- ----------------
ORACLE01  READ WRITE	       PRIMARY

SQL> 

SQL> alter database open;

Database altered.

SQL> select name,open_mode,database_role from v$database;

NAME	  OPEN_MODE	       DATABASE_ROLE
--------- -------------------- ----------------
ORACLE01  READ WRITE	       PRIMARY

SQL> select name from v$database;

NAME
---------
ORACLE01

SQL> show pdbs;

    CON_ID CON_NAME			  OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
	 2 PDB$SEED			  READ ONLY  NO
	 3 ODS				  MOUNTED
	 4 PDB2 			  MOUNTED

SQL> alter pluggable database ODS open;

Pluggable database altered.

SQL> show pdbs;

    CON_ID CON_NAME			  OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
	 2 PDB$SEED			  READ ONLY  NO
	 3 ODS				  READ WRITE NO
	 4 PDB2 			  MOUNTED
SQL> 
```


## 5. Checking synchronization

**On Primary**

- Login a PDB (name ODS)

`sqlplus keepwalking@172.16.0.10/ODS`

Or

```
sqlplus / as sysdba
SQL> alter session set container=ODS;
```
- Create a table

```SQL
CREATE TABLE KEEPWALKING.customers(
    person_id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    first_name VARCHAR2(50) NOT NULL,
    last_name VARCHAR2(50) NOT NULL,
    PRIMARY KEY(person_id)
);
```

- Insert data

```SQL
BEGIN
FOR i IN 1..1000000 LOOP
        INSERT INTO customers (person_id,first_name,last_name)
            VALUES (i,'KEEP','WALKING');
END LOOP;
COMMIT;
END;
/

```

**On Standby**

- Login into PDB (ODS)

```
sqlplus / as sysdba
SQL> alter session set container=ODS;
```

- Check data

SQL> select count(*) from customers;

  COUNT(*)
----------
	 1000000